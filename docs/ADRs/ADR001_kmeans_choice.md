# ADR 001: Выбор алгоритма кластеризации и числа кластеров

**Статус:** Принято  
**Дата:** 10 декабря 2025  
**Автор:** Команда геопланирования  

## Контекст и проблема

Требуется распределить 633 географические точки (1125 ежемесячных визитов) между 3 менеджерами по 22 рабочим дням месяца. Каждый рабочий день имеет жесткие ограничения:

- **4 часа на дорогу** (максимум ~160 км при скорости 40 км/ч с коэффициентом дорог 1.2)
- **5 часов на работу с клиентами** (~16 минут на визит при среднем 18.41 визитах в день)

Данные демонстрируют сильную кластеризацию на малых масштабах:

- 3 менеджера с 206–215 точками каждый
- 326–405 визитов в месяц на менеджера
- Ripley's K >> 1 на масштабе 1–5 км (сильная пространственная группировка)
- Moran's I ≈ 0.10–0.28 (слабая корреляция частоты посещений с расстоянием)

**Ключевое требование:** Фиксированное количество кластеров = 22 (по рабочим дням месяца).

## Рассмотренные варианты

### Вариант 1: DBSCAN

**Плюсы:**
- Автоматически определяет число кластеров
- Устойчив к выбросам

**Минусы:**
- Не гарантирует ровно 22 кластера (в тестах дает 8–10)
- Требует настройки параметров ε и min_samples

**Результаты тестов:**
- Силуэт: 0.815 (высокий)
- Нарушения ограничений: 5.33–6.67
- Неконтролируемое количество кластеров

### Вариант 2: Стандартный KMeans

**Плюсы:**
- Контролируемое количество кластеров
- Простая реализация

**Минусы:**
- Не учитывает ограничения по нагрузке (перегруженные кластеры)

**Результаты тестов:**
- KMeans k=22: силуэт 0.517, компактность 3.14 км, нарушения 9.33
- Перегруженные кластеры: до 43 визитов при лимите 25

### Вариант 3: Capacitated KMeans (выбранный)

**Плюсы:**
- Контролируемое количество кластеров
- Соблюдение ограничений по нагрузке
- Гибкая пост-обработка

**Минусы:**
- Более сложная реализация
- Требует итеративной настройки

**Результаты тестов:**
- Силуэт: 0.496
- Компактность: 2.52 км
- Нарушения: **0.00** (единственный алгоритм без нарушений)
- Макс. визитов: 25 (строго соответствует лимиту)

## Решение

Выбран **Capacitated KMeans** с фиксированным k=22 для каждого менеджера.

### Детали реализации

```python
class KMeansCapacitated(ClusteringStrategy):
    def fit_predict(self, points_df, config):
        # 1. Базовая KMeans кластеризация с k=22
        # 2. Итеративная пост-обработка:
        #    - Выявление перегруженных кластеров (>25 визитов)
        #    - Разделение на подкластеры
        #    - Перепривязка изолированных точек
        # 3. Проверка всех ограничений