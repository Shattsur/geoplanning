# Геопланировщик визитов (GeoPlanner)

GeoPlanner — инструмент для оптимизации маршрутов визитов полевых менеджеров. Проект автоматизирует пространственную кластеризацию точек, маршрутизацию по реальным дорогам (через локальный OSRM), планирование визитов по рабочим дням и генерацию наглядных визуализаций и отчётов.

Система учитывает практические ограничения бизнеса: нагрузку по визитам, время в пути, повторные визиты, а также отсев изолированных или неэффективных точек.

Реализован для поиска новых идей для маршрутизации. В данной реализации одновременно работают сервер OSRM и Streamlit приложение.

---

## Возможности

**Кластеризация**
- Capacitated K-Means с контролем нагрузки.
- Балансировка по количеству визитов, точек и географическому диаметру кластеров.

**Маршрутизация**
- Оптимизация маршрутов по реальным дорогам.
- Локальный OSRM (MLD).
- TSP-подобная оптимизация.
- Чанковая обработка больших матриц расстояний.

**Планирование**
- Балансировка визитов по рабочим дням.
- Учёт минимального и максимального числа визитов в день.
- Интервалы между повторными визитами (LoadBalancingScheduling).

**Визуализация и отчёты**
- Интерактивные карты Folium с реальной дорожной геометрией.
- PDF-отчёты с графиками (matplotlib + ReportLab).
- Excel-файлы со ссылками на маршруты в Яндекс.Картах.

**Интерфейсы**
- CLI-пайплайн (`main.py`).
- Веб-приложение на Streamlit (`app.py`).

**Дополнительно**
- Валидация входных данных.
- Обработка дубликатов точек.
- Fallback на Haversine с коэффициентом пробок при недоступности OSRM.

---

## Требования

- Python 3.10+
- Docker (для локального OSRM)
- ОС: Windows / Linux (основная разработка и тестирование — Windows)

Основные библиотеки:
`pandas`, `numpy`, `scikit-learn`, `folium`, `reportlab`, `playwright`, `streamlit`, `python-dotenv`  
Полный список — в `requirements.txt`.

---

## Установка

```bash
git clone <repo-url>
cd geoplanning
pip install -r requirements.txt
playwright install
```

Создайте файл `.env` в корне проекта:

```text
DATA_PATH=path/to/data.csv
```

---

## Подготовка данных

Входные данные — CSV-файл со следующими колонками:

| Поле      | Тип    | Описание |
|----------|--------|----------|
| point_id | str    | Уникальный идентификатор точки |
| manager  | int    | ID менеджера |
| lat      | float  | Широта |
| lon      | float  | Долгота |
| n_visits | int    | Количество визитов за период |

Пример: `data/data.csv`.

**Рекомендации**
- Все точки должны находиться в пределах одного региона (под OSRM).
- Дубликаты `point_id` по умолчанию автоматически переименовываются (`_2`, `_3`, …). Поведение настраивается в конфиге.

---

## Подготовка OSRM

OSRM используется для расчёта реальных дорожных расстояний и геометрии маршрутов.

### 1. Загрузка карты
Скачайте `.osm.pbf` файл региона с https://download.geofabrik.de  
и поместите его в папку `osrm_data/`.

### 2. Подготовка данных (Docker)

Пример для `volga-fed-district-latest.osm.pbf`:

```bash
cd osrm_data

docker run -t -v "$(pwd):/data" ghcr.io/project-osrm/osrm-backend   osrm-extract -p /opt/car.lua /data/volga-fed-district-latest.osm.pbf

docker run -t -v "$(pwd):/data" ghcr.io/project-osrm/osrm-backend   osrm-partition /data/volga-fed-district-latest.osrm

docker run -t -v "$(pwd):/data" ghcr.io/project-osrm/osrm-backend   osrm-customize /data/volga-fed-district-latest.osrm
```

### 3. Запуск сервера

**Windows**
```bash
start_osrm.bat
```

**Linux**
```bash
docker run -t -i -p 5000:5000 -v "$(pwd)":/data   ghcr.io/project-osrm/osrm-backend   osrm-routed --algorithm mld /data/volga-fed-district-latest.osrm
```

### 4. Проверка

Откройте в браузере:

```
http://127.0.0.1:5000/route/v1/driving/43.0,56.0;43.1,56.1?overview=false
```

Сервер должен вернуть JSON.

---

## Запуск

### CLI

```bash
python main.py   --data data/data.csv   --config configs/default_config.yaml   --verbose
```

**Результаты**
- HTML-карты
- Excel со ссылками Яндекс.Карт
- PDF-отчёты

Все файлы сохраняются в `outputs/`.

---

### Streamlit-приложение

```bash
streamlit run app.py
```

В браузере:
1. Загрузите CSV.
2. Выберите менеджеров.
3. Настройте параметры.
4. Запустите оптимизацию и скачайте отчёты.

---

## Конфигурация

Настройки задаются в YAML-файлах (`configs/default_config.yaml`). Основные секции:

- `data_processing` — фильтрация менеджеров, режим дубликатов.
- `clustering` — параметры Capacitated K-Means.
- `routing` — ограничения по дистанции и времени.
- `scheduling` — мин/макс визитов в день, интервалы повторов.
- `visualization` — параметры карт и PDF.

---

## Структура проекта

```
geoplanning/
├── data/            # CSV с входными данными
├── notebooks/       # EDA и эксперименты
├── src/
│   ├── core/        # Интерфейсы и валидация
│   ├── strategies/  # Кластеризация, маршрутизация, планирование
│   ├── utils/       # Загрузка данных, расстояния, визуализация
│   └── visualization/
├── configs/         # YAML-конфиги
├── osrm_data/       # OSRM-данные и скрипты
├── outputs/         # Результаты
├── main.py          # CLI-пайплайн
├── app.py           # Streamlit UI
└── requirements.txt
```

---

## Выходные данные

- **Карты** — интерактивные HTML (Folium).
- **Отчёты** — PDF с метриками и графиками.
- **Ссылки** — Excel с маршрутами для Яндекс.Карт.
- **Логи** — подробный вывод в консоль (`--verbose`).

---

## Примечания

- Для корректной работы маршрутизации OSRM должен быть запущен локально.
- При недоступности OSRM используется приближённый расчёт (Haversine).
- Проект ориентирован на практическое планирование визитов в реальных регионах.
